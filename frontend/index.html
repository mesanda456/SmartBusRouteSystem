<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üöå Smart Bus Route Finder - Sri Lanka</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
    --bg:#0f172a;--card:#1e293b;--border:#334155;--txt:#f1f5f9;--sub:#94a3b8;--dim:#64748b;
    --accent:#3b82f6;--green:#22c55e;--red:#ef4444;--orange:#f97316;--purple:#a855f7;
}
.light{--bg:#f1f5f9;--card:#ffffff;--border:#e2e8f0;--txt:#1e293b;--sub:#475569;--dim:#94a3b8}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);height:100vh;overflow:hidden;color:var(--txt);transition:background .3s,color .3s}
.app{display:grid;grid-template-columns:420px 1fr;height:100vh}
.sidebar{background:var(--card);display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden;transition:background .3s}
.header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.header-icon{width:34px;height:34px;background:linear-gradient(135deg,#3b82f6,#06b6d4);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px}
.header h1{font-size:14px;font-weight:700}
.header-sub{color:var(--dim);font-size:10px;font-family:'Space Mono',monospace}
.hdr-btns{margin-left:auto;display:flex;gap:4px}
.hdr-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--sub);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;transition:all .15s}
.hdr-btn:hover,.hdr-btn.on{border-color:var(--accent);color:var(--accent);background:rgba(59,130,246,.1)}
.status{display:flex;align-items:center;gap:4px;font-size:10px;font-family:'Space Mono',monospace;color:var(--dim)}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--red);animation:pulse 2s infinite}
.status-dot.on{background:var(--green)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Tabs */
.tabs{
    display:flex;
    overflow-x:auto;      /* enable horizontal scroll */
    overflow-y:hidden;
    white-space:nowrap;   /* keep tabs in one line */
    scrollbar-width:none; /* Firefox */
}

.tabs::-webkit-scrollbar{
    display:none;         /* Chrome/Safari hide scrollbar */
}

.tab{
    flex:0 0 auto;        /* DO NOT stretch equally */
    min-width:90px;       /* give fixed width */
    padding:10px 12px;
}

.tabs{
    -webkit-overflow-scrolling: touch;
}

.tabs {
    position: relative;
}

.tabs::after{
    content:'';
    position:absolute;
    right:0;
    top:0;
    width:30px;
    height:100%;
    background:linear-gradient(to right, transparent, var(--bg));
    pointer-events:none;
}
.tab{flex:1;padding:8px;text-align:center;font-size:11px;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--dim);transition:all .15s}
.tab:hover{color:var(--txt)}
.tab.active{
    color:white;
    background:var(--accent);
    border-radius:8px 8px 0 0;
}
.tab-icon{font-size:14px;display:block;margin-bottom:2px}

/* Search */
.search{padding:12px 16px;border-bottom:1px solid var(--border)}
.search-row{position:relative;margin-bottom:8px}
.search-row label{display:block;color:var(--dim);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.sinput{width:100%;padding:9px 10px 9px 32px;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;color:var(--txt);font-size:13px;font-family:inherit;transition:border .2s}
.sinput:focus{outline:none;border-color:var(--accent)}
.sinput::placeholder{color:var(--dim)}
.search-row .ico{position:absolute;left:10px;bottom:8px;font-size:13px}
.aclist{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:0 0 7px 7px;max-height:160px;overflow-y:auto;z-index:100;display:none}
.aclist.show{display:block}
.acitem{padding:7px 10px;cursor:pointer;display:flex;align-items:center;gap:7px;border-bottom:1px solid var(--bg);transition:background .1s;font-size:12px}
.acitem:hover{background:var(--border)}
.acitem .badge{min-width:26px;height:22px;background:var(--accent);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:white;font-family:'Space Mono',monospace}
.scoord{color:var(--dim);font-size:9px;font-family:'Space Mono',monospace}
.row-btns{display:flex;gap:4px;margin-top:4px}
.sm-btn{display:inline-flex;align-items:center;gap:3px;background:none;border:1px dashed var(--dim);border-radius:5px;color:var(--accent);font-size:10px;font-weight:600;padding:4px 8px;cursor:pointer}
.sm-btn:hover{border-color:var(--accent);background:rgba(59,130,246,.06)}
.swap-btn{display:flex;width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border);background:var(--card);color:var(--sub);font-size:12px;cursor:pointer;margin:-2px auto;position:relative;z-index:5;align-items:center;justify-content:center;transition:all .2s}
.swap-btn:hover{border-color:var(--accent);color:var(--accent);transform:rotate(180deg)}
.go-btn{width:100%;padding:10px;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:8px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;transition:all .2s}
.go-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}

.compare-btn {
    margin-top: 10px;
    background: linear-gradient(135deg, #ff8c42, #ff6a00);
    color: white;
    border: none;
    width: 100%;
    padding: 14px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.compare-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 106, 0, 0.4);
}

/* Panel content */
.panel{flex:1;overflow-y:auto;padding:0;display:none}
.panel.active{display:block}
.panel::-webkit-scrollbar{width:4px}
.panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.panel{
    opacity:0;
    transform:translateY(10px);
    transition:all .25s ease;
}

.panel.active{
    opacity:1;
    transform:translateY(0);
}
.empty{text-align:center;padding:40px 16px;color:var(--dim)}
.empty .eicon{font-size:36px;margin-bottom:8px}
.empty h3{color:var(--sub);font-size:14px;margin-bottom:3px}
.empty p{font-size:11px}


/* Transit cards */
.tcard{border-bottom:1px solid var(--border);padding:12px 16px;cursor:pointer;transition:background .15s}
.tcard:hover{background:rgba(59,130,246,.04)}
.tcard.active{background:rgba(59,130,246,.08);border-left:3px solid var(--accent)}
.tcard-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.tcard-time{font-size:14px;font-weight:700}
.tcard-dur{font-size:12px;color:var(--sub);font-family:'Space Mono',monospace}
.tcard-label{font-size:9px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.seg-strip{display:flex;align-items:center;gap:3px;flex-wrap:wrap;margin-bottom:6px}
.seg-walk{color:var(--sub);font-size:10px}
.seg-arrow{color:var(--dim);font-size:9px}
.bus-badge{padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;color:white;font-family:'Space Mono',monospace}
.bus-badge.c0{background:#4285F4}.bus-badge.c1{background:#34A853}.bus-badge.c2{background:#EA8600}
.bus-badge.c3{background:#EA4335}.bus-badge.c4{background:#7B1FA2}.bus-badge.c5{background:#0097A7}
.tcard-info{display:flex;gap:12px;font-size:10px;color:var(--dim)}
.tcard-info span{display:flex;align-items:center;gap:2px}
.tcard-detail{display:none;margin-top:10px;border-top:1px solid var(--border);padding-top:10px}
.tcard.active .tcard-detail{display:block}
.dseg{display:flex;gap:10px;padding:4px 0}
.dseg .dline{width:3px;border-radius:2px;min-height:28px;flex-shrink:0}
.dseg .dline.walk{background:var(--sub)}
.dseg .dcont{flex:1}
.dseg .dtype{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:1px}
.dseg .dtype.walk{color:var(--sub)}.dseg .dtype.bus{color:#60a5fa}
.dseg .dtxt{font-size:11px}.dseg .dsub{font-size:9px;color:var(--dim);margin-top:1px}

/* Schedule panel */
.sch-card{padding:12px 16px;border-bottom:1px solid var(--border)}
.sch-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--bg)}
.sch-bus{font-weight:700;font-size:13px}
.sch-time{font-family:'Space Mono',monospace;font-size:12px;color:var(--accent)}
.sch-wait{font-size:11px;color:var(--green);font-weight:600}
.sch-type{font-size:9px;padding:2px 6px;border-radius:3px;font-weight:600}
.sch-type.sltb{background:rgba(34,197,94,.15);color:#22c55e}
.sch-type.private{background:rgba(59,130,246,.15);color:#3b82f6}

/* Fare panel */
.fare-card{padding:16px;border-bottom:1px solid var(--border)}
.fare-type{font-weight:700;font-size:14px;margin-bottom:4px}
.fare-price{font-size:24px;font-weight:700;color:var(--accent);font-family:'Space Mono',monospace}
.fare-detail{font-size:11px;color:var(--dim)}

/* Alert card */
.alert-card{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px}
.alert-icon{font-size:20px;flex-shrink:0}
.alert-title{font-weight:700;font-size:12px;margin-bottom:2px}
.alert-msg{font-size:11px;color:var(--sub)}
.alert-loc{font-size:10px;color:var(--dim);margin-top:2px}

/* Chart */
.chart-wrap{padding:16px}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.bar-label{width:80px;font-size:11px;font-weight:600;text-align:right}
.bar-track{flex:1;height:20px;background:var(--bg);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:6px;font-size:9px;color:white;font-weight:700;font-family:'Space Mono',monospace;transition:width .5s}

/* Graph viz */
#graphCanvas{width:100%;height:400px;background:var(--bg);border-radius:8px;margin:8px 0}

/* Nearby */
.nearby-card{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;cursor:pointer}
.nearby-card:hover{background:rgba(59,130,246,.04)}
.nearby-dist{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);min-width:50px;text-align:right}
.nearby-walk{font-size:10px;color:var(--dim)}

/* History */
.hist-card{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;cursor:pointer}
.hist-card:hover{background:rgba(59,130,246,.04)}
.hist-route{font-size:12px;font-weight:600}
.hist-time{font-size:10px;color:var(--dim);margin-left:auto}
.hist-fav{font-size:14px;cursor:pointer;margin-left:4px}

.loading{text-align:center;padding:30px}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}

.map-wrap{position:relative}
#map{width:100%;height:100vh}
.map-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:rgba(15,23,42,.95);padding:16px 24px;border-radius:10px;border:1px solid var(--border);text-align:center;display:none}
.map-loading.show{display:block}
.map-loading p{color:var(--sub);font-size:12px;margin-top:6px}
.map-type-ctrl{position:absolute;top:10px;right:10px;z-index:1000;display:flex;gap:3px;background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:8px;padding:4px}
.map-type-btn{padding:5px 10px;border:none;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;background:transparent;color:var(--sub);transition:all .15s}
.map-type-btn.active{background:var(--accent);color:white}
.map-type-btn:hover:not(.active){background:rgba(255,255,255,.1)}
.legend{position:absolute;bottom:10px;right:10px;z-index:1000;background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:9px}
.legend .ltitle{font-weight:700;color:var(--accent);font-family:'Space Mono',monospace;font-size:8px;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px}
.legend .litem{display:flex;align-items:center;gap:4px;margin-bottom:2px;color:var(--sub)}
.legend .ldot{width:6px;height:6px;border-radius:50%;flex-shrink:0}

/* Rating panel */
.star-rating{display:flex;gap:6px;margin:6px 0}
.star-rating span{font-size:22px;cursor:pointer;transition:transform .1s}
.star-rating span:hover,.star-rating span.selected{transform:scale(1.2)}
.rating-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px}
.rating-bar-track{flex:1;background:var(--border);border-radius:4px;height:7px;overflow:hidden}
.rating-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#f59e0b,#fbbf24);transition:width .5s}
.review-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:8px;font-size:12px}
.review-card .rc-head{display:flex;justify-content:space-between;margin-bottom:4px;font-size:11px;color:var(--dim)}
.review-card .rc-stars{color:#f59e0b;letter-spacing:1px}
.review-card .rc-comment{color:var(--sub);margin-top:4px}
.top-bus-card{display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer;transition:border-color .2s}
.top-bus-card:hover{border-color:var(--accent)}
.top-bus-num{min-width:44px;height:44px;background:linear-gradient(135deg,#f59e0b,#f97316);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:white}

/* Ticket panel */
.ticket-card{background:linear-gradient(135deg,var(--accent),#0ea5e9);border-radius:12px;padding:16px;color:white;margin:12px 16px;position:relative;overflow:hidden}
.ticket-card::after{content:'';position:absolute;right:-20px;top:50%;transform:translateY(-50%);width:40px;height:40px;background:var(--bg);border-radius:50%}
.ticket-card::before{content:'';position:absolute;left:-20px;top:50%;transform:translateY(-50%);width:40px;height:40px;background:var(--bg);border-radius:50%}
.ticket-id{font-family:'Space Mono',monospace;font-size:11px;opacity:.8;margin-bottom:4px}
.ticket-route{font-size:18px;font-weight:700;margin-bottom:2px}
.ticket-meta{font-size:11px;opacity:.8;margin-top:6px}
.ticket-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.4)}
.qr-box{background:white;border-radius:8px;padding:8px;text-align:center;margin:10px 16px}
.qr-box canvas{display:block;margin:0 auto}
.qr-box .qr-label{font-size:10px;color:#64748b;font-family:'Space Mono',monospace;margin-top:4px}



/* Crowd panel */
.crowd-badge{padding:20px;border-radius:12px;border:2px solid;text-align:center;margin:12px 16px}
.crowd-level{font-size:22px;font-weight:700;margin:8px 0}
.crowd-icon{font-size:40px}
.crowd-seats{font-size:11px;color:var(--dim);margin-top:6px}


/* Lang selector */
.lang-sel{position:absolute;top:10px;left:10px;z-index:1000;display:flex;gap:2px;background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:8px;padding:3px}
.lang-btn{padding:4px 8px;border:none;border-radius:4px;font-size:10px;cursor:pointer;background:transparent;color:var(--sub);font-weight:600}
.lang-btn.active{background:var(--accent);color:white}

@media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{max-height:55vh;overflow-y:auto}#map{height:45vh}}
</style>
</head>
<body>
<div class="app">
<div class="sidebar">
    <div class="header">
        <div class="header-icon">üöå</div>
        <div><h1 data-i18n="title">Bus Route Finder</h1><div class="header-sub">Sri Lanka Transit</div></div>
        <div class="hdr-btns">
            <div class="hdr-btn" onclick="toggleTheme()" title="Dark/Light Mode">üåó</div>
            <div class="hdr-btn" onclick="startVoice()" title="Voice Search" id="voiceBtn">üé§</div>
        </div>
    </div>
    <div style="padding:4px 16px;"><div class="status"><div class="status-dot" id="sDot"></div><span id="sTxt">Offline</span></div></div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('routes')"><span class="tab-icon">üîé</span>Routes</div>
        <div class="tab" onclick="showTab('schedule')"><span class="tab-icon">üïê</span>Schedule</div>
        <div class="tab" onclick="showTab('fare')"><span class="tab-icon">üí∞</span>Fare</div>
        <div class="tab" onclick="showTab('nearby')"><span class="tab-icon">üìç</span>Nearby</div>
        <div class="tab" onclick="showTab('alerts')"><span class="tab-icon">‚ö†Ô∏è</span>Alerts</div>
        <div class="tab" onclick="showTab('more')"><span class="tab-icon">üìä</span>More</div>
        <div class="tab" onclick="showTab('crowd')"><span class="tab-icon">üë•</span>Crowd</div>
        <div class="tab" onclick="showTab('rating')"><span class="tab-icon">‚≠ê</span>Rating</div>
        <div class="tab" onclick="showTab('ticket')"><span class="tab-icon">üé´</span>Ticket</div>
    </div>

    <!-- ROUTES PANEL -->
    <div class="panel active" id="p-routes">
        <div class="search">
            <div class="search-row"><label data-i18n="from">From</label><span class="ico">üìç</span>
                <input class="sinput" id="srcIn" placeholder="Your location..." autocomplete="off">
                <div class="aclist" id="srcAC"></div>
                <div class="row-btns"><button class="sm-btn" onclick="useMyLocation()">üì° GPS</button><button class="sm-btn" onclick="startVoice('src')">üé§ Voice</button></div>
            </div>
            <button class="swap-btn" onclick="swap()">‚áÖ</button>
            <div class="search-row"><label data-i18n="to">To</label><span class="ico">üéØ</span>
                <input class="sinput" id="dstIn" placeholder="Where to?" autocomplete="off">
                <div class="aclist" id="dstAC"></div>
            </div>
            <select class="sinput" id="routeMode" style="padding-left:10px;margin-top:8px">
                <option value="distance">üîµ Shortest Distance</option>
                <option value="time">üü¢ Fastest Time</option>
                <option value="cost">üü£ Cheapest Cost</option>
            </select>
            <button class="go-btn" onclick="findTransit()" data-i18n="search">üîé Search Bus Routes</button>
            <button class="search-btn compare-btn" onclick="compareAlgorithms()">
                ‚ö° Compare Algorithms
            </button>
        </div>
        <div id="results"><div class="empty"><div class="eicon">üó∫Ô∏è</div><h3 data-i18n="searchHint">Search for a bus route</h3><p>Nugegoda ‚Üí Fort Railway Station</p></div></div>
        <!-- Route comparison chart -->
        <div id="chartArea" style="display:none"></div>
    </div>

    <!-- SCHEDULE PANEL -->
    <div class="panel" id="p-schedule">
        <div class="search" style="padding:12px 16px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Select Bus Stop</label>
            <select class="sinput" id="schStop" style="padding-left:10px" onchange="loadSchedule()"></select>
        </div>
        <div id="schResults"><div class="empty"><div class="eicon">üïê</div><h3>Select a stop to see departures</h3></div></div>
    </div>

    <!-- FARE PANEL -->
    <div class="panel" id="p-fare">
        <div class="search" style="padding:12px 16px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Distance (km)</label>
            <input class="sinput" id="fareKm" type="number" placeholder="Enter distance..." style="padding-left:10px" value="10">
            <button class="go-btn" onclick="calcFare()" style="margin-top:8px">üí∞ Calculate Fare</button>
        </div>
        <div id="fareResults"></div>
    </div>

    <!-- NEARBY PANEL -->
    <div class="panel" id="p-nearby">
        <div class="search" style="padding:12px 16px">
            <button class="go-btn" onclick="findNearby()">üìç Find Nearby Bus Stops</button>
        </div>
        <div id="nearbyResults"><div class="empty"><div class="eicon">üìç</div><h3>Find stops near you</h3><p>Uses your GPS location</p></div></div>
    </div>

    <!-- ALERTS PANEL -->
    <div class="panel" id="p-alerts">
        <div id="alertResults"><div class="loading"><div class="spinner"></div></div></div>
    </div>



    <!-- CROWD PREDICTION PANEL -->
    <div class="panel" id="p-crowd">
        <div class="search" style="padding:12px 16px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Bus Stop</label>
            <select class="sinput" id="crowdStop" style="padding-left:10px"></select>
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;margin-top:10px;display:block">Departure Time</label>
            <input class="sinput" id="crowdTime" type="time" value="08:00" style="padding-left:10px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;margin-top:10px;display:block">Day Type</label>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button id="btnWeekday" class="go-btn" onclick="setDayType('WEEKDAY')" style="background:#3b82f6;margin-top:0">üìÖ Weekday</button>
                <button id="btnWeekend" class="go-btn" onclick="setDayType('WEEKEND')" style="background:#334155;margin-top:0">üèñÔ∏è Weekend</button>
            </div>
            <button class="go-btn" onclick="checkCrowd()">üë• Check Crowd Level</button>
        </div>
        <div id="crowdResult"></div>
    </div>

    <!-- RATING PANEL -->
    <div class="panel" id="p-rating">
        <div class="search" style="padding:12px 16px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Bus Number</label>
            <input class="sinput" id="ratingBusNum" placeholder="e.g. 100, 138, 400..." style="padding-left:10px" value="100">
            <button class="go-btn" onclick="loadBusRatings()" style="margin-top:8px">‚≠ê Load Ratings</button>
        </div>
        <!-- Top rated buses -->
        <div style="padding:0 16px 8px">
            <div style="font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üèÜ Top Rated Buses</div>
            <div id="topBusList"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        <!-- Ratings for selected bus -->
        <div id="busRatingDetail" style="display:none;padding:0 16px 16px">
            <div style="height:1px;background:var(--border);margin:8px 0"></div>
            <div id="busRatingHeader"></div>
            <div id="busRatingBars" style="margin:10px 0"></div>
            <!-- Submit new rating -->
            <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin:10px 0">
                <div style="font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;margin-bottom:8px">Rate This Bus</div>
                <div style="font-size:12px;margin-bottom:4px;color:var(--sub)">Cleanliness</div>
                <div class="star-rating" id="starsCleanliness">
                    <span onclick="setStar('cleanliness',1)" data-val="1">‚òÜ</span>
                    <span onclick="setStar('cleanliness',2)" data-val="2">‚òÜ</span>
                    <span onclick="setStar('cleanliness',3)" data-val="3">‚òÜ</span>
                    <span onclick="setStar('cleanliness',4)" data-val="4">‚òÜ</span>
                    <span onclick="setStar('cleanliness',5)" data-val="5">‚òÜ</span>
                </div>
                <div style="font-size:12px;margin-bottom:4px;color:var(--sub)">Driver</div>
                <div class="star-rating" id="starsDriver">
                    <span onclick="setStar('driver',1)" data-val="1">‚òÜ</span>
                    <span onclick="setStar('driver',2)" data-val="2">‚òÜ</span>
                    <span onclick="setStar('driver',3)" data-val="3">‚òÜ</span>
                    <span onclick="setStar('driver',4)" data-val="4">‚òÜ</span>
                    <span onclick="setStar('driver',5)" data-val="5">‚òÜ</span>
                </div>
                <div style="font-size:12px;margin-bottom:4px;color:var(--sub)">Punctuality</div>
                <div class="star-rating" id="starsPunctuality">
                    <span onclick="setStar('punctuality',1)" data-val="1">‚òÜ</span>
                    <span onclick="setStar('punctuality',2)" data-val="2">‚òÜ</span>
                    <span onclick="setStar('punctuality',3)" data-val="3">‚òÜ</span>
                    <span onclick="setStar('punctuality',4)" data-val="4">‚òÜ</span>
                    <span onclick="setStar('punctuality',5)" data-val="5">‚òÜ</span>
                </div>
                <input class="sinput" id="ratingComment" placeholder="Write a comment (optional)..." style="padding-left:10px;margin-top:8px">
                <button class="go-btn" onclick="submitRating()" style="margin-top:8px">‚úÖ Submit Rating</button>
                <div id="ratingMsg" style="font-size:12px;margin-top:6px;text-align:center"></div>
            </div>
            <!-- Recent reviews -->
            <div style="font-size:11px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Recent Reviews</div>
            <div id="reviewsList"></div>
        </div>
    </div>

    <!-- TICKET PANEL -->
    <div class="panel" id="p-ticket">
        <div class="search" style="padding:12px 16px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">From Stop</label>
            <input class="sinput" id="ticketFrom" placeholder="e.g. Colombo Fort" style="padding-left:10px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;margin-top:8px;display:block">To Stop</label>
            <input class="sinput" id="ticketTo" placeholder="e.g. Kandy" style="padding-left:10px">
            <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;margin-top:8px;display:block">Bus Number</label>
            <input class="sinput" id="ticketBus" placeholder="e.g. 100" style="padding-left:10px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
                <div>
                    <label style="color:var(--dim);font-size:9px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Fare (Rs.)</label>
                    <input class="sinput" id="ticketFare" type="number" placeholder="150" style="padding-left:10px" value="100">
                </div>
                <div>
                    <label style="color:var(--dim);font-size:9px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Distance (km)</label>
                    <input class="sinput" id="ticketDist" type="number" placeholder="25" style="padding-left:10px" value="20">
                </div>
            </div>
            <button class="go-btn" onclick="generateTicket()" style="margin-top:8px">üé´ Generate Ticket</button>
        </div>
        <div id="ticketResult" style="display:none">
            <div class="ticket-card" id="ticketCard"></div>
            <div class="qr-box" id="qrBox">
                <canvas id="qrCanvas"></canvas>
                <div class="qr-label">Scan to verify ticket</div>
            </div>
            <div style="padding:0 16px 16px;display:flex;gap:8px">
                <button class="go-btn" onclick="printTicket()" style="flex:1;margin-top:0;background:var(--border);color:var(--txt)">üñ®Ô∏è Print</button>
                <button class="go-btn" onclick="generateTicket()" style="flex:1;margin-top:0">üé´ New Ticket</button>
            </div>
        </div>
        <div id="ticketEmpty" style="padding:40px 16px;text-align:center;color:var(--dim)">
            <div style="font-size:48px;margin-bottom:12px">üé´</div>
            <h3 style="color:var(--sub);margin-bottom:4px">No ticket yet</h3>
            <p style="font-size:12px">Fill in the details above and generate your bus ticket</p>
        </div>
    </div>


    <!-- MORE PANEL (Graph, History, Favorites) -->
    <div class="panel" id="p-more">
        <div class="tabs" style="border-top:1px solid var(--border)">
            <div class="tab active" onclick="showSubTab('history')">üìú History</div>
            <div class="tab" onclick="showSubTab('favorites')">‚≠ê Favorites</div>
            <div class="tab" onclick="showSubTab('graph')">üîó Graph</div>
            <div class="tab" onclick="showSubTab('algo')">‚ö° Algorithm</div>
        </div>
        <div id="sub-history" class="panel active"></div>
        <div id="sub-favorites" class="panel"></div>
        <div id="sub-graph" class="panel"></div>
        <div id="sub-algo" class="panel">
            <div class="search" style="padding:12px 16px">
                <label style="color:var(--dim);font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:4px;display:block">Algorithm Visualization</label>
                <select class="sinput" id="algoSel" style="padding-left:10px">
                    <option value="dijkstra">Dijkstra's Algorithm</option>
                    <option value="bfs">BFS (Breadth-First Search)</option>
                    <option value="astar">A* Algorithm</option>
                </select>
                <button class="go-btn" onclick="runAlgoViz()" style="margin-top:8px">‚ö° Visualize Algorithm</button>
            </div>
            <div id="algoSteps"></div>
        </div>
    </div>
</div>
<div class="map-wrap">
    <div id="map"></div>
    <div class="map-loading" id="mapLoading"><div class="spinner"></div><p>Loading route...</p></div>
    <div class="map-type-ctrl">
        <button class="map-type-btn active" onclick="setMapType('roadmap',this)">Map</button>
        <button class="map-type-btn" onclick="setMapType('satellite',this)">Satellite</button>
        <button class="map-type-btn" onclick="setMapType('terrain',this)">Terrain</button>
        <button class="map-type-btn" onclick="setMapType('hybrid',this)">Hybrid</button>
    </div>
    <div class="lang-sel">
        <button class="lang-btn active" onclick="setLang('en',this)">EN</button>
        <button class="lang-btn" onclick="setLang('si',this)">‡∑É‡∑í‡∂Ç</button>
        <button class="lang-btn" onclick="setLang('ta',this)">‡Æ§‡ÆÆ‡Æø</button>
    </div>
    <div class="legend">
        <div class="ltitle">Legend</div>
        <div class="litem"><div class="ldot" style="background:#4285F4"></div>Bus Stop</div>
        <div class="litem"><div class="ldot" style="background:#22c55e"></div>Start</div>
        <div class="litem"><div class="ldot" style="background:#ef4444"></div>End</div>
        <div class="litem"><div class="ldot" style="background:#f97316"></div>Bus Route</div>
        <div class="litem"><div class="ldot" style="background:#94a3b8"></div>Walking</div>
    </div>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API='http://localhost:8080/api',OSRM='https://router.project-osrm.org/route/v1/driving';
const GKEY='AIzaSyAG0W7RJFWmsTR02I91CmFwTi32Y4Gwp9c';
const COLORS=['#4285F4','#34A853','#EA8600','#EA4335','#7B1FA2','#0097A7'];
let map,stops=[],stopMarkers=[],routeLayers=[],selSrc=null,selDst=null,tileLayers={},currentTile;
const roadCache={};
let favorites = [];
let history=JSON.parse(localStorage.getItem('busHist')||'[]');

// fav

async function loadFavoritesFromAPI(){
    try{
        const response = await fetch(API + "/favorites");
        favorites = await response.json();
        renderFavorites();
    }catch(e){
        console.error("Error loading favorites", e);
    }
}

// ===== I18N =====
const LANG={
    en:{title:'Bus Route Finder',from:'From',to:'To',search:'üîé Search Bus Routes',searchHint:'Search for a bus route',walk:'Walk',board:'Board',alight:'Alight',min:'min',stops:'stops',transfers:'transfer'},
    si:{title:'‡∂∂‡∑É‡∑ä ‡∂∏‡∑è‡∂ª‡∑ä‡∂ú ‡∑É‡∑ô‡∑Ä‡∑ì‡∂∏',from:'‡∑É‡∑í‡∂ß',to:'‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è',search:'üîé ‡∂∂‡∑É‡∑ä ‡∂∏‡∑è‡∂ª‡∑ä‡∂ú ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±',searchHint:'‡∂∂‡∑É‡∑ä ‡∂∏‡∑è‡∂ª‡∑ä‡∂ú‡∂∫‡∂ö‡∑ä ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±',walk:'‡∂á‡∑Ä‡∑í‡∂Ø‡∑ì‡∂∏',board:'‡∂±‡∑ê‡∂ú‡∑ì‡∂∏',alight:'‡∂∂‡∑ê‡∑É‡∑ì‡∂∏',min:'‡∂∏‡∑í‡∂±‡∑í',stops:'‡∂±‡∑ê‡∑Ä‡∂≠‡∑î‡∂∏‡∑ä',transfers:'‡∂∏‡∑è‡∂ª‡∑î'},
    ta:{title:'‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æµ‡Æ¥‡Æø ‡Æ§‡Øá‡Æü‡Æ≤‡Øç',from:'‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ',to:'‡Æµ‡Æ∞‡Øà',search:'üîé ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æµ‡Æ¥‡Æø‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡ØÅ',searchHint:'‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æµ‡Æ¥‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',walk:'‡Æ®‡Æü‡Øà',board:'‡Æè‡Æ±‡ØÅ',alight:'‡Æá‡Æ±‡Æô‡Øç‡Æï‡ØÅ',min:'‡Æ®‡Æø‡ÆÆ‡Æø',stops:'‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æô‡Øç‡Æï‡Æ≥‡Øç',transfers:'‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç'}
};
let curLang='en';
function setLang(l,btn){curLang=l;document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.dataset.i18n;if(LANG[l][k])el.textContent=LANG[l][k];})}

// ===== THEME =====
let isDark=true;
function toggleTheme(){isDark=!isDark;document.body.classList.toggle('light',!isDark)}

// ===== INIT =====
window.onload=()=>{
    map=L.map('map',{zoomControl:true}).setView([6.9271,79.8612],12);
    tileLayers.roadmap=L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key='+GKEY,{maxZoom:20,attribution:'¬© Google'});
    tileLayers.satellite=L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}&key='+GKEY,{maxZoom:20});
    tileLayers.terrain=L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}&key='+GKEY,{maxZoom:20});
    tileLayers.hybrid=L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}&key='+GKEY,{maxZoom:20});
    currentTile=tileLayers.roadmap;currentTile.addTo(map);
    checkAPI();loadStops();setupAC('srcIn','srcAC','src');setupAC('dstIn','dstAC','dst');
    loadAlerts();renderHistory();renderFavorites();
    loadFavoritesFromAPI();
};
function setMapType(t,btn){if(currentTile)map.removeLayer(currentTile);currentTile=tileLayers[t];currentTile.addTo(map);
document.querySelectorAll('.map-type-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active')}

async function checkAPI(){try{const r=await fetch(API+'/health');const on=r.ok;document.getElementById('sDot').className='status-dot'+(on?' on':'');document.getElementById('sTxt').textContent=on?'Online':'Offline'}catch{}}
async function loadStops(){try{const r=await fetch(API+'/stops');stops=await r.json();showAllStops();populateSchSelect();populateCrowdSelect()}catch(e){console.error(e)}}
function mkIcon(c,s){return L.divIcon({html:`<div style="width:${s}px;height:${s}px;background:${c};border:2px solid rgba(255,255,255,.9);border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.3)"></div>`,className:'',iconSize:[s,s],iconAnchor:[s/2,s/2]})}
function showAllStops(){stopMarkers.forEach(m=>map.removeLayer(m));stopMarkers=[];const b=[];
stops.forEach(s=>{const ll=[s.latitude,s.longitude];b.push(ll);const m=L.marker(ll,{icon:mkIcon('#4285F4',7)}).addTo(map);
m.bindPopup(`<b>${s.name}</b><br><small>${s.id}</small>`);stopMarkers.push(m)});if(b.length)map.fitBounds(b,{padding:[30,30]})}

// ===== TABS =====
function showTab(t){document.querySelectorAll('.panel').forEach(p=>{if(p.id.startsWith('p-'))p.classList.remove('active')});
document.getElementById('p-'+t).classList.add('active');document.querySelectorAll('.tabs>.tab').forEach((tb,i)=>tb.classList.toggle('active',tb.textContent.trim().toLowerCase().includes(t.slice(0,3))))}
function showSubTab(t){document.querySelectorAll('#p-more .panel').forEach(p=>p.classList.remove('active'));
document.getElementById('sub-'+t).classList.add('active');document.querySelectorAll('#p-more .tabs .tab').forEach(tb=>tb.classList.toggle('active',tb.textContent.toLowerCase().includes(t.slice(0,4))))}

// ===== AUTOCOMPLETE =====
function setupAC(inId,listId,type){const inp=document.getElementById(inId),list=document.getElementById(listId);
inp.addEventListener('input',()=>{const q=inp.value.trim().toLowerCase();if(q.length<1){list.classList.remove('show');return}
const m=stops.filter(s=>s.name.toLowerCase().includes(q)||s.id.toLowerCase().includes(q)).slice(0,6);
if(!m.length){list.classList.remove('show');return}
list.innerHTML=m.map(s=>`<div class="acitem" data-id="${s.id}"><div class="badge">${s.id}</div><div><div>${s.name}</div><div class="scoord">${s.latitude.toFixed(4)}, ${s.longitude.toFixed(4)}</div></div></div>`).join('');
list.classList.add('show');list.querySelectorAll('.acitem').forEach(it=>it.onclick=()=>{const st=stops.find(s=>s.id===it.dataset.id);inp.value=st.name;list.classList.remove('show');if(type==='src')selSrc=st;else selDst=st})});
document.addEventListener('click',e=>{if(!e.target.closest('.search-row'))list.classList.remove('show')})}

function useMyLocation(){if(!navigator.geolocation){alert('GPS not supported');return}
navigator.geolocation.getCurrentPosition(p=>{const lat=p.coords.latitude,lng=p.coords.longitude;let near=null,md=Infinity;
stops.forEach(s=>{const d=Math.hypot(s.latitude-lat,s.longitude-lng);if(d<md){md=d;near=s}});
if(near){document.getElementById('srcIn').value=near.name;selSrc=near}
const m=L.marker([lat,lng],{icon:L.divIcon({html:'<div style="width:14px;height:14px;background:#a855f7;border:3px solid white;border-radius:50%;box-shadow:0 0 10px #a855f7"></div>',className:'',iconSize:[14,14],iconAnchor:[7,7]})}).addTo(map);
m.bindPopup('<b>üì° You</b>');routeLayers.push(m);map.setView([lat,lng],15)},()=>alert('Enable GPS'))}
function swap(){const a=document.getElementById('srcIn'),b=document.getElementById('dstIn');const t=a.value;a.value=b.value;b.value=t;const ts=selSrc;selSrc=selDst;selDst=ts}

// ===== VOICE SEARCH =====
function startVoice(field){if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)){alert('Voice not supported');return}
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;const rec=new SR();rec.lang='en-US';rec.continuous=false;
document.getElementById('voiceBtn').classList.add('on');
rec.onresult=e=>{const t=e.results[0][0].transcript;
if(field==='src'){document.getElementById('srcIn').value=t;const m=stops.find(s=>s.name.toLowerCase().includes(t.toLowerCase()));if(m)selSrc=m}
else{document.getElementById('dstIn').value=t;const m=stops.find(s=>s.name.toLowerCase().includes(t.toLowerCase()));if(m)selDst=m}
document.getElementById('voiceBtn').classList.remove('on')};
rec.onerror=()=>document.getElementById('voiceBtn').classList.remove('on');rec.start()}

// ===== OSRM ROUTING =====
async function getRoad(a,b,c,d){const k=`${a},${b}-${c},${d}`;if(roadCache[k])return roadCache[k];
try{const r=await fetch(`${OSRM}/${b},${a};${d},${c}?overview=full&geometries=geojson`);const j=await r.json();
if(j.routes&&j.routes[0]){const co=j.routes[0].geometry.coordinates.map(p=>[p[1],p[0]]);roadCache[k]=co;return co}}catch(e){}return[[a,b],[c,d]]}
async function getFullRoad(seg){if(seg.polyline&&seg.polyline.length>1){const a=[];for(let i=0;i<seg.polyline.length-1;i++){const p1=seg.polyline[i],p2=seg.polyline[i+1];
const pts=await getRoad(p1[0],p1[1],p2[0],p2[1]);if(!a.length)a.push(...pts);else a.push(...pts.slice(1))}return a}return await getRoad(seg.fromLat,seg.fromLng,seg.toLat,seg.toLng)}

// ===== TRANSIT SEARCH =====
async function findTransit(){

    if(!selSrc || !selDst){
        alert('Select both locations');
        return;
    }

    if(selSrc.id === selDst.id){
        alert('Same location');
        return;
    }

    addHistory(selSrc, selDst);

    document.getElementById('results').innerHTML =
        '<div class="loading"><div class="spinner"></div><p>Finding routes...</p></div>';

    try{

        const mode = document.getElementById("routeMode").value;

        const r = await fetch(
            `${API}/transit?source=${selSrc.id}&destination=${selDst.id}&mode=${mode}`
        );

        // ‚úÖ ADD THIS CHECK
        if(!r.ok){
            throw new Error("Server error: " + r.status);
        }

        const opts = await r.json();

        // ‚úÖ EXTRA SAFETY
        if(!opts || opts.length === 0){
            document.getElementById('results').innerHTML =
                '<div class="empty"><div class="eicon">‚ùå</div><h3>No routes found</h3></div>';
            return;
        }

        renderOptions(opts);
        renderChart(opts);

    }catch(e){
        console.error("Transit error:", e);

        document.getElementById('results').innerHTML =
            '<div class="empty"><div class="eicon">‚ö†Ô∏è</div><h3>API Error</h3><p>Check backend server</p></div>';
    }
}

function fmtD(minutes){
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;

    if(h > 0){
        return `${h}h ${m}m`;
    }
    return `${m}m`;
}

async function compareAlgorithms() {

    if (!selSrc || !selDst) {
        alert("Select source and destination first");
        return;
    }

    const mode = document.getElementById("routeMode").value;

    try {

        const r = await fetch(
            `${API}/transit/compare?source=${selSrc.id}&destination=${selDst.id}&mode=${mode}`
        );

        if(!r.ok){
            throw new Error("Server error");
        }

        const data = await r.json();

        renderOptions(data);   // show cards
        renderChart(data);     // show comparison chart

    } catch(e){
        console.error("Compare error:", e);
        alert("Compare failed. Check backend.");
    }
}




function renderOptions(opts){

    const resultsDiv = document.getElementById('results');

    resultsDiv.innerHTML = opts.map((o,i)=>{

        const strip=o.segments.map((s,si)=>
            s.type==='walk'
            ? `<span class="seg-walk">üö∂${s.durationMinutes}m</span><span class="seg-arrow">‚Ä∫</span>`
            : `<span>üöå<span class="bus-badge c${si%6}">${s.busNumber}</span></span>${
                si<o.segments.length-1?'<span class="seg-arrow">‚Ä∫</span>':''
              }`
        ).join('');

        const det=o.segments.map((s,si)=>
            s.type==='walk'
            ? `<div class="dseg"><div class="dline walk"></div>
               <div class="dcont">
                   <div class="dtype walk">üö∂ Walk ${s.durationMinutes} min</div>
                   <div class="dtxt">${s.fromStop} ‚Üí ${s.toStop}</div>
               </div></div>`
            : `<div class="dseg">
                   <div class="dline bus" style="background:${COLORS[si%6]}"></div>
                   <div class="dcont">
                       <div class="dtype bus">üöå Bus ${s.busNumber}</div>
                       <div class="dtxt">${s.fromStop} ‚Üí ${s.toStop}</div>
                   </div>
               </div>`
        ).join('');

        return `
        <div class="tcard${i===0?' active':''}" onclick="pickOpt(${i})">
            <div class="tcard-top">
                <span class="tcard-time">${o.departureTime} ‚Äî ${o.arrivalTime}</span>
                <span class="tcard-dur">${fmtD(o.totalDurationMinutes)}</span>
            </div>
            <div class="seg-strip">${strip}</div>
            <div class="tcard-info">
                <span>üí∞Rs.${o.totalCostRs}</span>
                <span>üìç${o.totalStops} stops</span>
                <span>üîÑ${o.transfers}</span>
            </div>
            <div class="tcard-detail">${det}</div>
        </div>`;
    }).join('');

    window._opts = opts;
    drawOnMap(opts[0]);

    // üî• PERFORMANCE PANEL
    if (opts.length > 0 && opts[0].executionTime !== undefined) {

        const execTime = opts[0].executionTime;
        const visited = opts[0].nodesVisited;

        resultsDiv.innerHTML += `
            <div style="
                background:var(--bg);
                border:1px solid var(--border);
                border-radius:8px;
                padding:12px;
                margin:12px 16px;
                font-size:12px;
            ">
                <div style="font-weight:700;color:var(--accent);margin-bottom:6px">
                    ‚ö° Algorithm Performance
                </div>
                ‚è± Execution Time: <b>${execTime} ms</b><br>
                üîé Nodes Visited: <b>${visited}</b>
            </div>
        `;
    }
}


// ===== ROUTE COMPARISON CHART =====
function renderChart(opts){if(opts.length<2){document.getElementById('chartArea').style.display='none';return}
document.getElementById('chartArea').style.display='block';const maxT=Math.max(...opts.map(o=>o.totalDurationMinutes)),maxC=Math.max(...opts.map(o=>o.totalCostRs));
document.getElementById('chartArea').innerHTML='<div class="chart-wrap"><h3 style="font-size:13px;margin-bottom:10px;color:var(--sub)">üìä Route Comparison</h3>'+
opts.map((o,i)=>`<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;margin-bottom:4px">${o.label||'Route '+(i+1)} ${o.busNumbers.map(b=>`<span class="bus-badge c${i%6}" style="font-size:8px">${b}</span>`).join(' ')}</div>
<div class="bar-row"><div class="bar-label">‚è± Time</div><div class="bar-track"><div class="bar-fill" style="width:${o.totalDurationMinutes/maxT*100}%;background:${COLORS[i%6]}">${o.totalDurationMinutes}m</div></div></div>
<div class="bar-row"><div class="bar-label">üí∞ Cost</div><div class="bar-track"><div class="bar-fill" style="width:${o.totalCostRs/maxC*100}%;background:${COLORS[(i+1)%6]}">Rs.${o.totalCostRs}</div></div></div></div>`).join('')+'</div>'}

// ===== DRAW ON MAP =====
async function drawOnMap(opt){routeLayers.forEach(l=>map.removeLayer(l));routeLayers=[];const bounds=[];
document.getElementById('mapLoading').classList.add('show');
for(let si=0;si<opt.segments.length;si++){const seg=opt.segments[si];const from=[seg.fromLat,seg.fromLng],to=[seg.toLat,seg.toLng];bounds.push(from,to);
if(seg.type==='walk'){const wl=L.polyline([from,to],{color:'#888',weight:4,dashArray:'8,10',opacity:.7}).addTo(map);routeLayers.push(wl)}
else{const ci=si%6;const road=await getFullRoad(seg);road.forEach(p=>bounds.push(p));
const sh=L.polyline(road,{color:'rgba(0,0,0,.2)',weight:11,lineCap:'round'}).addTo(map);routeLayers.push(sh);
const ml=L.polyline(road,{color:COLORS[ci],weight:7,opacity:.9,lineCap:'round'}).addTo(map);routeLayers.push(ml);
const mid=road[Math.floor(road.length/2)];const bl=L.marker(mid,{icon:L.divIcon({html:`<div style="background:${COLORS[ci]};color:white;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;font-family:'Space Mono',monospace;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,.4)">üöå ${seg.busNumber}</div>`,className:'',iconAnchor:[20,-5]}),interactive:false}).addTo(map);routeLayers.push(bl);
const bm=L.marker(from,{icon:mkIcon(COLORS[ci],12)}).addTo(map);bm.bindPopup(`<b>üöå Board</b><br>${seg.fromStop}<br><b style="color:${COLORS[ci]}">Bus ${seg.busNumber}</b>`);routeLayers.push(bm);
const am=L.marker(to,{icon:mkIcon(COLORS[ci],12)}).addTo(map);am.bindPopup(`<b>üîΩ Alight</b><br>${seg.toStop}`);routeLayers.push(am)}}
if(opt.segments.length>0){const f=opt.segments[0],l=opt.segments[opt.segments.length-1];
const sm=L.marker([f.fromLat,f.fromLng],{icon:mkIcon('#22c55e',18)}).addTo(map);sm.bindPopup('<b>üìç Start</b>');routeLayers.push(sm);
const em=L.marker([l.toLat,l.toLng],{icon:mkIcon('#ef4444',18)}).addTo(map);em.bindPopup('<b>üéØ Destination</b>');routeLayers.push(em)}
document.getElementById('mapLoading').classList.remove('show');if(bounds.length)map.fitBounds(bounds,{padding:[50,50]});

// === LIVE BUS SIMULATION ===
simulateBus(opt)}

// ===== REAL-TIME BUS TRACKING (Simulation) =====
let busAnimMarker=null;
function simulateBus(opt){if(busAnimMarker){map.removeLayer(busAnimMarker);busAnimMarker=null}
const busSegs=opt.segments.filter(s=>s.type==='bus');if(!busSegs.length)return;
const seg=busSegs[0];const from=[seg.fromLat,seg.fromLng],to=[seg.toLat,seg.toLng];
busAnimMarker=L.marker(from,{icon:L.divIcon({html:'<div style="width:20px;height:20px;background:#f97316;border:3px solid white;border-radius:50%;box-shadow:0 0 12px #f97316;animation:pulse 1s infinite"></div>',className:'',iconSize:[20,20],iconAnchor:[10,10]}),zIndex:9999}).addTo(map);
busAnimMarker.bindPopup(`<b>üöå Live Bus ${seg.busNumber}</b><br>En route`);routeLayers.push(busAnimMarker);
let step=0;const total=50;
const iv=setInterval(()=>{step++;if(step>=total){clearInterval(iv);return}const t=step/total;
const lat=from[0]+(to[0]-from[0])*t;const lng=from[1]+(to[1]-from[1])*t;
if(busAnimMarker)busAnimMarker.setLatLng([lat,lng])},200)}

// ===== SCHEDULE =====
function populateSchSelect(){const sel=document.getElementById('schStop');sel.innerHTML='<option value="">-- Select --</option>'+stops.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
async function loadSchedule(){const id=document.getElementById('schStop').value;if(!id)return;
try{const r=await fetch(`${API}/schedule?stopId=${id}`);const d=await r.json();
document.getElementById('schResults').innerHTML=`<div class="sch-card"><b>${d.stopName}</b> ¬∑ <small>${d.timestamp}</small></div>`+
(d.departures||[]).map(dep=>`<div class="sch-row"><div><span class="bus-badge c${parseInt(dep.busNumber)%6}">${dep.busNumber}</span> <span class="sch-type ${dep.type==='SLTB'?'sltb':'private'}">${dep.type}</span></div>
<div class="sch-time">${dep.time}</div><div class="sch-wait">${dep.waitMinutes} min</div></div>`).join('')}catch(e){document.getElementById('schResults').innerHTML='<div class="empty"><div class="eicon">‚ö†Ô∏è</div><h3>Error loading schedule</h3></div>'}}

// ===== FARE CALCULATOR =====
async function calcFare(){const km=parseFloat(document.getElementById('fareKm').value)||10;
try{const r=await fetch(`${API}/fare?distanceKm=${km}`);const d=await r.json();
document.getElementById('fareResults').innerHTML=[d.sltb,d.private,d.ac].map((f,i)=>`<div class="fare-card">
<div class="fare-type">${['üöå SLTB (Government)','üöê Private Bus','‚ùÑÔ∏è AC / Luxury'][i]}</div>
<div class="fare-price">Rs. ${f.fare}</div>
<div class="fare-detail">Base: Rs.${f.baseFare} + Rs.${f.perKm}/km √ó ${km}km</div></div>`).join('')}catch(e){}}

// ===== NEARBY STOPS =====
async function findNearby(){if(!navigator.geolocation){alert('GPS not supported');return}
document.getElementById('nearbyResults').innerHTML='<div class="loading"><div class="spinner"></div></div>';
navigator.geolocation.getCurrentPosition(async p=>{try{const r=await fetch(`${API}/stops/nearby?lat=${p.coords.latitude}&lng=${p.coords.longitude}&radiusKm=3`);const d=await r.json();
document.getElementById('nearbyResults').innerHTML=d.length?d.map(n=>`<div class="nearby-card" onclick="map.setView([${n.stop.latitude},${n.stop.longitude}],16)">
<div>üìç</div><div style="flex:1"><div style="font-weight:600;font-size:12px">${n.stop.name}</div><div class="nearby-walk">üö∂ ${n.walkMinutes} min walk</div></div>
<div class="nearby-dist">${n.distanceKm} km</div></div>`).join(''):'<div class="empty"><h3>No stops nearby</h3></div>'}catch(e){}},()=>alert('Enable GPS'))}

// ===== TRAFFIC ALERTS =====
async function loadAlerts(){try{const r=await fetch(`${API}/traffic/alerts`);const d=await r.json();
document.getElementById('alertResults').innerHTML=d.map(a=>{const icons={warning:'‚ö†Ô∏è',construction:'üöß',info:'‚ÑπÔ∏è',weather:'üåßÔ∏è'};
return`<div class="alert-card" onclick="map.setView([${a.latitude},${a.longitude}],15)"><div class="alert-icon">${icons[a.type]||'‚ö†Ô∏è'}</div>
<div><div class="alert-title">${a.title}</div><div class="alert-msg">${a.message}</div><div class="alert-loc">üìç ${a.location} ¬∑ ${a.timestamp}</div></div></div>`}).join('')}catch(e){document.getElementById('alertResults').innerHTML='<div class="empty"><h3>Cannot load alerts</h3></div>'}}

// ===== HISTORY & FAVORITES =====

// Load favorites from backend when page loads
async function loadFavoritesFromAPI(){
    try{
        const res = await fetch(API + "/favorites");
        favorites = await res.json();
        renderFavorites();
        renderHistory(); // refresh stars in history
    }catch(e){
        console.error("Failed to load favorites", e);
    }
}

// ===== HISTORY (keep localStorage for history only) =====
function addHistory(src,dst){
    history.unshift({
        src:src.id,
        srcN:src.name,
        dst:dst.id,
        dstN:dst.name,
        time:new Date().toLocaleTimeString()
    });

    history = history.slice(0,10);
    localStorage.setItem('busHist',JSON.stringify(history));
    renderHistory();
}

function renderHistory(){
    document.getElementById('sub-history').innerHTML =
    history.length ?
    history.map((h,i)=>`
        <div class="hist-card" onclick="quickSearch('${h.src}','${h.dst}')">
            <div>üïê</div>
            <div style="flex:1">
                <div class="hist-route">${h.srcN} ‚Üí ${h.dstN}</div>
            </div>
            <div class="hist-time">${h.time}</div>
            <div class="hist-fav"
                onclick="event.stopPropagation();toggleFav('${h.src}','${h.srcN}','${h.dst}','${h.dstN}')">
                ${isFav(h.srcN,h.dstN)?'‚≠ê':'‚òÜ'}
            </div>
        </div>
    `).join('')
    :
    '<div class="empty"><div class="eicon">üìú</div><h3>No recent searches</h3></div>';
}

// ===== FAVORITES (Now using Backend API) =====

async function toggleFav(sId,sN,dId,dN){

    const existing = favorites.find(f =>
        f.source === sN && f.destination === dN
    );

    try{
        if(existing){
            // DELETE favorite from backend
            await fetch(API + "/favorites/" + existing.id,{
                method:"DELETE"
            });
        }else{
            // SAVE favorite to backend
            await fetch(API + "/favorites",{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({
                    source:sN,
                    destination:dN,
                    algorithm:"dijkstra"
                })
            });
        }

        await loadFavoritesFromAPI();

    }catch(e){
        console.error("Favorite update failed", e);
    }
}

function isFav(sourceName,destinationName){
    return favorites.some(f =>
        f.source === sourceName &&
        f.destination === destinationName
    );
}

function renderFavorites(){

    const container = document.getElementById('sub-favorites');

    if(!favorites || favorites.length === 0){
        container.innerHTML = `
        <div class="empty">
            <div class="eicon">‚≠ê</div>
            <h3>No favorites yet</h3>
            <p>Star routes from history</p>
        </div>`;
        return;
    }

    container.innerHTML = favorites.map(f=>`
        <div class="hist-card">
            <div>‚≠ê</div>
            <div style="flex:1">
                <div class="hist-route">${f.source} ‚Üí ${f.destination}</div>
            </div>
            <div class="hist-fav"
                onclick="event.stopPropagation();deleteFavorite(${f.id})">
                ‚ùå
            </div>
        </div>
    `).join('');
}

async function deleteFavorite(id){
    try{
        await fetch(API + "/favorites/" + id,{
            method:"DELETE"
        });
        await loadFavoritesFromAPI();
    }catch(e){
        console.error(e);
    }
}

// Quick search remains same
function quickSearch(sId,dId){
    const s = stops.find(x=>x.id===sId),
          d = stops.find(x=>x.id===dId);

    if(s && d){
        selSrc = s;
        selDst = d;
        document.getElementById('srcIn').value = s.name;
        document.getElementById('dstIn').value = d.name;
        showTab('routes');
        findTransit();
    }
}
// ===== GRAPH VISUALIZATION =====
async function loadGraph(){try{const r=await fetch(`${API}/graph`);const g=await r.json();
let h=`<div style="padding:12px 16px"><h3 style="font-size:13px;margin-bottom:8px">üîó Graph: ${g.totalNodes} nodes, ${g.totalEdges} edges</h3>`;
// Draw on map
routeLayers.forEach(l=>map.removeLayer(l));routeLayers=[];
g.edges.forEach(e=>{const line=L.polyline([[e.fromLat,e.fromLng],[e.toLat,e.toLng]],{color:'#3b82f6',weight:2,opacity:.5}).addTo(map);
line.bindPopup(`${e.from}‚Üí${e.to}: ${e.distance}km, ${e.time}min, Rs.${e.cost}`);routeLayers.push(line)});
g.nodes.forEach(n=>{const m=L.marker([n.lat,n.lng],{icon:mkIcon('#f97316',10)}).addTo(map);m.bindPopup(`<b>${n.name}</b> (${n.id})`);routeLayers.push(m)});
h+=`<p style="font-size:11px;color:var(--sub)">Graph edges shown on map. Click edges for details.</p></div>`;
document.getElementById('sub-graph').innerHTML=h}catch(e){}}

// ===== ALGORITHM STEP-BY-STEP =====
async function runAlgoViz(){const algo=document.getElementById('algoSel').value;
if(!selSrc||!selDst){alert('Select source and destination first');return}
routeLayers.forEach(l=>map.removeLayer(l));routeLayers=[];showAllStops();
const stepsDiv=document.getElementById('algoSteps');stepsDiv.innerHTML='<div class="loading"><div class="spinner"></div><p>Running '+algo+'...</p></div>';
try{const r=await fetch(`${API}/route?source=${selSrc.id}&destination=${selDst.id}&algorithm=${algo}&mode=distance`);const d=await r.json();
if(!d.found){stepsDiv.innerHTML='<div class="empty"><h3>No path found</h3></div>';return}
let html='<div style="padding:12px 16px"><h3 style="font-size:13px;margin-bottom:8px">‚ö° '+algo.toUpperCase()+' Steps</h3>';
const path=d.path;
for(let i=0;i<path.length;i++){const s=path[i];const isStart=i===0,isEnd=i===path.length-1;
html+=`<div style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
<div style="width:24px;height:24px;background:${isStart?'#22c55e':isEnd?'#ef4444':'#3b82f6'};border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:10px;font-weight:700">${i+1}</div>
<div style="flex:1"><div style="font-weight:600;font-size:12px">${s.name}</div><div style="font-size:10px;color:var(--dim)">${isStart?'Start node - Added to queue':isEnd?'Destination reached!':'Exploring neighbors...'}</div></div></div>`;
// Animate on map
setTimeout(()=>{const m=L.marker([s.latitude,s.longitude],{icon:mkIcon(isStart?'#22c55e':isEnd?'#ef4444':'#f97316',14)}).addTo(map);
m.bindPopup(`<b>Step ${i+1}</b><br>${s.name}`);routeLayers.push(m);
if(i>0){const prev=path[i-1];const line=L.polyline([[prev.latitude,prev.longitude],[s.latitude,s.longitude]],{color:'#f97316',weight:4,opacity:.8,dashArray:'6,4'}).addTo(map);routeLayers.push(line)}},i*500)}
html+=`<div style="margin-top:8px;padding:8px;background:rgba(34,197,94,.1);border-radius:6px;font-size:11px">‚úÖ Path found: ${path.length} nodes visited. Total: ${d.totalValue} ${d.mode==='time'?'min':d.mode==='cost'?'Rs.':'km'}</div></div>`;
stepsDiv.innerHTML=html}catch(e){stepsDiv.innerHTML='<div class="empty"><h3>Error running algorithm</h3></div>'}}


// ===== CROWD PREDICTION =====
function populateCrowdSelect(){
    const sel = document.getElementById('crowdStop');
    sel.innerHTML = '<option value="">-- Select Stop --</option>' +
        stops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
}

let selectedDayType = 'WEEKDAY';

function setDayType(type){
    selectedDayType = type;
    document.getElementById('btnWeekday').style.background = type === 'WEEKDAY' ? '#3b82f6' : '#334155';
    document.getElementById('btnWeekend').style.background = type === 'WEEKEND' ? '#7c3aed' : '#334155';
    // Auto re-check if a result is already showing
    if(document.getElementById('crowdResult').innerHTML !== ''){
        checkCrowd();
    }
}

async function checkCrowd(){
    const stopId = document.getElementById('crowdStop').value;
    const time = document.getElementById('crowdTime').value;
    if(!stopId){ alert('Please select a stop'); return; }
    try{
        const r = await fetch(`${API}/crowd?stopId=${stopId}&time=${time}&dayType=${selectedDayType}`);
        const d = await r.json();
        const colors = { HIGH:'#ef4444', MEDIUM:'#f59e0b', LOW:'#22c55e' };
        const c = colors[d.crowdLevel];
        const dayLabel = selectedDayType === 'WEEKEND' ? 'üèñÔ∏è Weekend' : 'üìÖ Weekday';
        document.getElementById('crowdResult').innerHTML = `
            <div class="crowd-badge" style="border-color:${c}">
                <div style="font-size:11px;color:var(--dim);margin-bottom:4px">${dayLabel}</div>
                <div class="crowd-icon">${d.icon}</div>
                <div class="crowd-level" style="color:${c}">${d.crowdLevel} CROWD</div>
                <div style="font-size:13px">${d.message}</div>
            </div>
            <div style="padding:0 16px">
                <div style="font-size:11px;color:var(--dim);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:1px">
                    ${selectedDayType === 'WEEKEND' ? 'üèñÔ∏è Weekend' : 'üìÖ Weekday'} Crowd by Time of Day
                </div>
                ${selectedDayType === 'WEEKEND' ? `
                ${[
                    {label:'Early Morning (5‚Äì8am)', level:'LOW'},
                    {label:'Morning (9‚Äì2pm)', level:'MEDIUM'},
                    {label:'Afternoon (3‚Äì6pm)', level:'LOW'},
                    {label:'Evening (7pm+)', level:'LOW'}
                ].map(row => {
                    const clr = colors[row.level];
                    return `<div class="bar-row">
                        <div class="bar-label" style="font-size:9px">${row.label}</div>
                        <div class="bar-track">
                            <div class="bar-fill" style="width:${row.level==='HIGH'?90:row.level==='MEDIUM'?50:15}%;background:${clr}">
                                ${row.level}
                            </div>
                        </div>
                    </div>`;
                }).join('')}` : `
                ${[
                    {label:'Early Morning (5‚Äì7am)', level:'LOW'},
                    {label:'Morning Peak (7‚Äì9am)', level:'HIGH'},
                    {label:'Mid Morning (10‚Äì11am)', level:'MEDIUM'},
                    {label:'Lunch (12‚Äì1pm)', level:'MEDIUM'},
                    {label:'Afternoon (2‚Äì3pm)', level:'LOW'},
                    {label:'Evening Peak (4‚Äì7pm)', level:'HIGH'},
                    {label:'Night (8pm+)', level:'LOW'}
                ].map(row => {
                    const clr = colors[row.level];
                    return `<div class="bar-row">
                        <div class="bar-label" style="font-size:9px">${row.label}</div>
                        <div class="bar-track">
                            <div class="bar-fill" style="width:${row.level==='HIGH'?90:row.level==='MEDIUM'?50:15}%;background:${clr}">
                                ${row.level}
                            </div>
                        </div>
                    </div>`;
                }).join('')}`}
            </div>`;
    }catch(e){ document.getElementById('crowdResult').innerHTML='<div class="empty"><h3>Error loading crowd data</h3></div>'; }
}

// Load graph when More tab's Graph subtab is opened
document.querySelectorAll('#p-more .tabs .tab').forEach(t=>t.addEventListener('click',()=>{if(t.textContent.includes('Graph'))loadGraph()}));







    // ===== RATING SERVICE =====
const ratingState = { cleanliness: 0, driver: 0, punctuality: 0 };

function setStar(category, val) {
    ratingState[category] = val;
    const containerId = 'stars' + category.charAt(0).toUpperCase() + category.slice(1);
    document.querySelectorAll('#' + containerId + ' span').forEach((s, i) => {
        s.textContent = i < val ? '‚≠ê' : '‚òÜ';
        s.classList.toggle('selected', i < val);
    });
}

async function loadTopBuses() {
    try {
        const r = await fetch(`${API}/ratings/top`);
        const buses = await r.json();
        const el = document.getElementById('topBusList');
        if (!buses.length) { el.innerHTML = '<div class="empty"><h3>No ratings yet</h3></div>'; return; }
        el.innerHTML = buses.slice(0, 5).map((b, i) => `
            <div class="top-bus-card" onclick="selectTopBus('${b.busNumber}')">
                <div class="top-bus-num">${b.busNumber}</div>
                <div style="flex:1">
                    <div style="font-size:13px;font-weight:600;color:var(--txt)">Bus ${b.busNumber}</div>
                    <div style="font-size:11px;color:var(--dim)">${b.totalReviews} reviews</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:15px;font-weight:700;color:#f59e0b">${b.avgOverall} ‚≠ê</div>
                    <div style="font-size:10px;color:var(--dim)">#${i+1} rated</div>
                </div>
            </div>`).join('');
    } catch(e) {
        document.getElementById('topBusList').innerHTML = '<div style="font-size:12px;color:var(--dim);padding:8px">Could not load ratings. Is the backend running?</div>';
    }
}

function selectTopBus(busNum) {
    document.getElementById('ratingBusNum').value = busNum;
    loadBusRatings();
}

async function loadBusRatings() {
    const busNum = document.getElementById('ratingBusNum').value.trim();
    if (!busNum) { alert('Please enter a bus number'); return; }
    try {
        const r = await fetch(`${API}/ratings/${busNum}`);
        const d = await r.json();
        document.getElementById('busRatingDetail').style.display = 'block';

        // Header
        const stars = '‚≠ê'.repeat(Math.round(d.avgOverall));
        document.getElementById('busRatingHeader').innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                <div style="width:56px;height:56px;background:linear-gradient(135deg,#f59e0b,#f97316);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:white">${busNum}</div>
                <div>
                    <div style="font-size:20px">${stars || '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'}</div>
                    <div style="font-size:22px;font-weight:700;color:var(--txt)">${d.avgOverall}/5</div>
                    <div style="font-size:11px;color:var(--dim)">${d.totalReviews} reviews</div>
                </div>
            </div>`;

        // Rating bars
        const bars = [
            { label: 'Cleanliness', val: d.avgCleanliness },
            { label: 'Driver',      val: d.avgDriver },
            { label: 'Punctuality', val: d.avgPunctuality }
        ];
        document.getElementById('busRatingBars').innerHTML = bars.map(b => `
            <div class="rating-bar-row">
                <span style="width:80px">${b.label}</span>
                <div class="rating-bar-track"><div class="rating-bar-fill" style="width:${b.val/5*100}%"></div></div>
                <span style="font-size:12px;font-weight:700;color:#f59e0b">${b.val}</span>
            </div>`).join('');

        // Reviews list
        const reviews = d.reviews || [];
        document.getElementById('reviewsList').innerHTML = reviews.length ? reviews.map(rv => `
            <div class="review-card">
                <div class="rc-head">
                    <span class="rc-stars">${'‚≠ê'.repeat(Math.round(rv.overall))}</span>
                    <span>${rv.timestamp}</span>
                </div>
                <div style="font-size:11px;color:var(--sub)">
                    üßπ Cleanliness: ${rv.cleanliness} &nbsp;|&nbsp; üöå Driver: ${rv.driver} &nbsp;|&nbsp; ‚è±Ô∏è Punctuality: ${rv.punctuality}
                </div>
                ${rv.comment ? `<div class="rc-comment">"${rv.comment}"</div>` : ''}
            </div>`).join('') : '<div style="font-size:12px;color:var(--dim);padding:8px">No reviews yet. Be the first!</div>';
    } catch(e) {
        alert('Could not load ratings. Make sure the backend is running.');
    }
}

async function submitRating() {
    const busNum = document.getElementById('ratingBusNum').value.trim();
    const comment = document.getElementById('ratingComment').value.trim();
    const msg = document.getElementById('ratingMsg');

    if (!busNum) { alert('Please enter a bus number first'); return; }
    if (!ratingState.cleanliness || !ratingState.driver || !ratingState.punctuality) {
        msg.innerHTML = '<span style="color:#ef4444">‚ö†Ô∏è Please rate all 3 categories</span>'; return;
    }

    try {
        msg.innerHTML = '<span style="color:var(--dim)">Submitting...</span>';
        const r = await fetch(`${API}/ratings/${busNum}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cleanliness: ratingState.cleanliness,
                driver: ratingState.driver,
                punctuality: ratingState.punctuality,
                comment
            })
        });
        if (r.ok) {
            msg.innerHTML = '<span style="color:#22c55e">‚úÖ Rating submitted!</span>';
            // Reset stars
            ['cleanliness','driver','punctuality'].forEach(c => setStar(c, 0));
            ratingState.cleanliness = ratingState.driver = ratingState.punctuality = 0;
            document.getElementById('ratingComment').value = '';
            setTimeout(() => { loadBusRatings(); loadTopBuses(); }, 800);
        }
    } catch(e) {
        msg.innerHTML = '<span style="color:#ef4444">‚ùå Error submitting rating</span>';
    }
}

// ===== TICKET SERVICE =====

// Simple QR code renderer (matrix-based, no library needed)
function drawQR(canvas, text) {
    // Use a basic visual QR placeholder - encode text as a simple pattern
    const ctx = canvas.getContext('2d');
    const size = 140;
    canvas.width = size; canvas.height = size;
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = '#000000';
    // Draw finder patterns (corners)
    function drawFinder(x, y) {
        ctx.fillRect(x, y, 21, 21);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(x+3, y+3, 15, 15);
        ctx.fillStyle = '#000000';
        ctx.fillRect(x+6, y+6, 9, 9);
    }
    drawFinder(7, 7); drawFinder(size-28, 7); drawFinder(7, size-28);
    // Encode text as pseudo-random data modules
    ctx.fillStyle = '#000000';
    const hash = text.split('').reduce((a, c) => ((a << 5) - a) + c.charCodeAt(0) | 0, 0);
    for (let row = 0; row < 25; row++) {
        for (let col = 0; col < 25; col++) {
            const bit = (hash ^ (row * 31 + col * 17) ^ (row << col)) & 1;
            if (bit) {
                const px = 7 + col * 5, py = 7 + row * 5;
                // skip finder pattern areas
                if ((px < 30 && py < 30) || (px > size-35 && py < 30) || (px < 30 && py > size-35)) continue;
                ctx.fillRect(px, py, 4, 4);
            }
        }
    }
    // Timing patterns
    for (let i = 14; i < size-14; i += 10) { ctx.fillRect(i, 33, 4, 4); ctx.fillRect(33, i, 4, 4); }
}

async function generateTicket() {
    const fromStop  = document.getElementById('ticketFrom').value.trim();
    const toStop    = document.getElementById('ticketTo').value.trim();
    const busNumber = document.getElementById('ticketBus').value.trim();
    const fare      = parseFloat(document.getElementById('ticketFare').value) || 100;
    const distKm    = parseFloat(document.getElementById('ticketDist').value) || 20;

    if (!fromStop || !toStop || !busNumber) { alert('Please fill in From, To and Bus Number'); return; }

    try {
        const r = await fetch(`${API}/ticket/generate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fromStop, toStop, busNumber, fare, distanceKm: distKm })
        });
        const t = await r.json();
        document.getElementById('ticketEmpty').style.display = 'none';
        document.getElementById('ticketResult').style.display = 'block';

        document.getElementById('ticketCard').innerHTML = `
            <div class="ticket-id">${t.ticketId} &nbsp;|&nbsp; ${t.passengerType}</div>
            <div class="ticket-route">üöå Bus ${t.busNumber}</div>
            <div style="font-size:13px;opacity:.9;margin-top:4px">üìç ${t.fromStop} ‚Üí ${t.toStop}</div>
            <div class="ticket-row">
                <div>
                    <div style="font-size:10px;opacity:.7">FARE</div>
                    <div style="font-size:20px;font-weight:700">Rs. ${t.fare.toFixed(2)}</div>
                </div>
                <div>
                    <div style="font-size:10px;opacity:.7">DISTANCE</div>
                    <div style="font-size:16px;font-weight:700">${t.distanceKm} km</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:10px;opacity:.7">STATUS</div>
                    <div style="font-size:13px;font-weight:700;background:rgba(255,255,255,.2);padding:2px 8px;border-radius:20px">${t.status}</div>
                </div>
            </div>
            <div class="ticket-meta">
                Issued: ${t.issueTime} &nbsp;|&nbsp; Valid until: ${t.validUntil}
            </div>`;

        // Draw QR code
        drawQR(document.getElementById('qrCanvas'), t.qrData);

    } catch(e) {
        alert('Could not generate ticket. Make sure the backend is running.');
    }
}

function printTicket() {
    const card = document.getElementById('ticketCard').outerHTML;
    const qr = document.getElementById('qrCanvas').toDataURL();
    const w = window.open('', '_blank');
    w.document.write(`<html><body style="font-family:sans-serif;padding:20px">${card}<br><img src="${qr}" style="width:140px"><br><p style="font-size:11px;color:#64748b">SLBUS Smart Ticket System</p></body></html>`);
    w.print(); w.close();
}

// Auto-load top buses when Rating tab is opened
document.querySelectorAll('.tabs>.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        if (tab.textContent.includes('Rating')) loadTopBuses();
    });
});

</script>
</body>
</html>