<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå Smart Bus Route Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:#0f172a;height:100vh;overflow:hidden}
        .app{display:grid;grid-template-columns:420px 1fr;height:100vh}

        .sidebar{background:#1e293b;display:flex;flex-direction:column;border-right:1px solid #334155;overflow:hidden}
        .header{padding:16px 20px;border-bottom:1px solid #334155;display:flex;align-items:center;gap:12px}
        .header-icon{width:38px;height:38px;background:linear-gradient(135deg,#3b82f6,#06b6d4);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .header h1{color:#f1f5f9;font-size:16px;font-weight:700}
        .header-sub{color:#64748b;font-size:11px;font-family:'Space Mono',monospace}
        .status{display:flex;align-items:center;gap:6px;margin-left:auto;font-size:11px;font-family:'Space Mono',monospace}
        .status-dot{width:7px;height:7px;border-radius:50%;animation:pulse 2s infinite}
        .status-dot.on{background:#22c55e}.status-dot.off{background:#ef4444}
        .status.on{color:#22c55e}.status.off{color:#ef4444}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

        .search{padding:16px 20px;border-bottom:1px solid #334155}
        .search-row{position:relative;margin-bottom:10px}
        .search-row label{display:block;color:#64748b;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
        .sinput{width:100%;padding:11px 12px 11px 36px;background:#0f172a;border:2px solid #334155;border-radius:8px;color:#f1f5f9;font-size:14px;font-family:inherit;transition:border .2s}
        .sinput:focus{outline:none;border-color:#3b82f6}
        .sinput::placeholder{color:#475569}
        .search-row .ico{position:absolute;left:12px;bottom:10px;font-size:14px}
        .aclist{position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid #334155;border-radius:0 0 8px 8px;max-height:180px;overflow-y:auto;z-index:100;display:none}
        .aclist.show{display:block}
        .acitem{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid #0f172a;transition:background .1s}
        .acitem:hover{background:#334155}
        .acitem .badge{min-width:28px;height:24px;background:#3b82f6;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;font-family:'Space Mono',monospace}
        .acitem .sname{color:#f1f5f9;font-size:13px}
        .acitem .scoord{color:#64748b;font-size:10px;font-family:'Space Mono',monospace}
        .loc-btn{display:inline-flex;align-items:center;gap:4px;background:none;border:1px dashed #475569;border-radius:6px;color:#3b82f6;font-size:11px;font-weight:600;padding:5px 10px;cursor:pointer;margin-top:4px;transition:all .15s}
        .loc-btn:hover{border-color:#3b82f6;background:rgba(59,130,246,.06)}
        .swap-btn{display:block;width:30px;height:30px;border-radius:50%;border:2px solid #334155;background:#1e293b;color:#94a3b8;font-size:14px;cursor:pointer;margin:-4px auto;position:relative;z-index:5;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .swap-btn:hover{border-color:#3b82f6;color:#3b82f6;transform:rotate(180deg)}
        .go-btn{width:100%;padding:12px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;margin-top:12px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;transition:all .2s}
        .go-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
        .go-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

        .results{flex:1;overflow-y:auto;padding:0}
        .results::-webkit-scrollbar{width:5px}
        .results::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}
        .empty{text-align:center;padding:50px 20px;color:#64748b}
        .empty .eicon{font-size:40px;margin-bottom:10px}
        .empty h3{color:#94a3b8;font-size:15px;margin-bottom:4px}
        .empty p{font-size:12px}

        .tcard{border-bottom:1px solid #334155;padding:16px 20px;cursor:pointer;transition:background .15s}
        .tcard:hover{background:rgba(59,130,246,.05)}
        .tcard.active{background:rgba(59,130,246,.1);border-left:3px solid #3b82f6}
        .tcard-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .tcard-time{font-size:15px;font-weight:700;color:#f1f5f9}
        .tcard-dur{font-size:13px;color:#94a3b8;font-family:'Space Mono',monospace}
        .tcard-label{font-size:10px;font-weight:600;color:#22c55e;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}

        .seg-strip{display:flex;align-items:center;gap:4px;flex-wrap:wrap;margin-bottom:8px}
        .seg-walk{display:flex;align-items:center;gap:2px;color:#94a3b8;font-size:11px}
        .seg-walk .wicon{font-size:13px}
        .seg-arrow{color:#475569;font-size:10px}
        .seg-bus{display:flex;align-items:center;gap:3px}
        .seg-bus .bicon{font-size:12px}
        .bus-badge{padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;color:white;font-family:'Space Mono',monospace}
        .bus-badge.blue{background:#4285F4}
        .bus-badge.green{background:#34A853}
        .bus-badge.orange{background:#EA8600}
        .bus-badge.red{background:#EA4335}
        .bus-badge.purple{background:#7B1FA2}
        .bus-badge.teal{background:#0097A7}

        .tcard-info{display:flex;gap:16px;font-size:11px;color:#64748b}
        .tcard-info span{display:flex;align-items:center;gap:3px}

        .tcard-detail{display:none;margin-top:12px;border-top:1px solid #334155;padding-top:12px}
        .tcard.active .tcard-detail{display:block}
        .detail-seg{display:flex;gap:12px;padding:6px 0}
        .detail-seg .d-line{width:4px;border-radius:2px;min-height:32px;flex-shrink:0}
        .detail-seg .d-line.walk{background:#94a3b8;border-style:dashed}
        .detail-seg .d-line.bus{background:#4285F4}
        .detail-seg .d-content{flex:1}
        .detail-seg .d-type{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
        .detail-seg .d-type.walk{color:#94a3b8}
        .detail-seg .d-type.bus{color:#60a5fa}
        .detail-seg .d-text{font-size:12px;color:#cbd5e1}
        .detail-seg .d-sub{font-size:10px;color:#64748b;margin-top:2px}

        .loading{text-align:center;padding:40px}
        .spinner{width:32px;height:32px;border:3px solid #334155;border-top-color:#3b82f6;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 12px}
        @keyframes spin{to{transform:rotate(360deg)}}

        .map-wrap{position:relative}
        #map{width:100%;height:100vh}
        .legend{position:absolute;top:12px;right:12px;z-index:1000;background:rgba(15,23,42,.9);backdrop-filter:blur(10px);border:1px solid #334155;border-radius:10px;padding:12px 16px;font-size:11px}
        .legend .ltitle{font-weight:700;color:#3b82f6;font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
        .legend .litem{display:flex;align-items:center;gap:6px;margin-bottom:4px;color:#94a3b8}
        .legend .ldot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

        .map-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:rgba(15,23,42,.95);padding:20px 30px;border-radius:12px;border:1px solid #334155;text-align:center;display:none}
        .map-loading.show{display:block}
        .map-loading p{color:#94a3b8;font-size:13px;margin-top:8px}

        @media(max-width:900px){
            .app{grid-template-columns:1fr}
            .sidebar{max-height:55vh;overflow-y:auto}
            #map{height:45vh}
        }
    </style>
</head>
<body>
<div class="app">
    <div class="sidebar">
        <div class="header">
            <div class="header-icon">üöå</div>
            <div><h1>Bus Route Finder</h1><div class="header-sub">Sri Lanka Transit</div></div>
            <div class="status" id="status">
                <div class="status-dot off" id="sDot"></div>
                <span id="sTxt">Offline</span>
            </div>
        </div>

        <div class="search">
            <div class="search-row">
                <label>From</label>
                <span class="ico">üìç</span>
                <input class="sinput" id="srcIn" placeholder="Your location..." autocomplete="off">
                <div class="aclist" id="srcAC"></div>
                <button class="loc-btn" onclick="useMyLocation()">üì° My Location</button>
            </div>
            <button class="swap-btn" onclick="swap()">‚áÖ</button>
            <div class="search-row">
                <label>To</label>
                <span class="ico">üéØ</span>
                <input class="sinput" id="dstIn" placeholder="Where to?" autocomplete="off">
                <div class="aclist" id="dstAC"></div>
            </div>
            <button class="go-btn" id="goBtn" onclick="findTransit()">üîé Search Bus Routes</button>
        </div>

        <div class="results" id="results">
            <div class="empty">
                <div class="eicon">üó∫Ô∏è</div>
                <h3>Search for a bus route</h3>
                <p>Example: Nugegoda ‚Üí Fort Railway Station</p>
            </div>
        </div>
    </div>

    <div class="map-wrap">
        <div id="map"></div>
        <div class="map-loading" id="mapLoading">
            <div class="spinner"></div>
            <p>Loading road route...</p>
        </div>
        <div class="legend">
            <div class="ltitle">Legend</div>
            <div class="litem"><div class="ldot" style="background:#3b82f6"></div>Bus Stop</div>
            <div class="litem"><div class="ldot" style="background:#22c55e"></div>Start</div>
            <div class="litem"><div class="ldot" style="background:#ef4444"></div>End</div>
            <div class="litem"><div class="ldot" style="background:#f97316"></div>Bus Route (on road)</div>
            <div class="litem"><div class="ldot" style="background:#94a3b8;border:1px dashed #64748b"></div>Walking</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = 'http://localhost:8080/api';
const OSRM = 'https://router.project-osrm.org/route/v1/driving';

let map, stops=[], stopMarkers=[], routeLayers=[], selSrc=null, selDst=null, activeCard=-1;
const COLORS = ['#4285F4','#34A853','#EA8600','#EA4335','#7B1FA2','#0097A7'];
const COLOR_NAMES = ['blue','green','orange','red','purple','teal'];

// Road geometry cache to avoid repeated API calls
const roadCache = {};

window.onload = () => { initMap(); checkAPI(); loadStops(); setupAC('srcIn','srcAC','src'); setupAC('dstIn','dstAC','dst'); };

function initMap(){
    map = L.map('map').setView([6.9271,79.8612],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'¬© OpenStreetMap',
        maxZoom:19
    }).addTo(map);
}

async function checkAPI(){try{const r=await fetch(API+'/health');setAPI(r.ok)}catch{setAPI(false)}}
function setAPI(on){
    document.getElementById('sDot').className='status-dot '+(on?'on':'off');
    document.getElementById('sTxt').textContent=on?'Online':'Offline';
    document.getElementById('status').className='status '+(on?'on':'off');
}
async function loadStops(){try{const r=await fetch(API+'/stops');stops=await r.json();showAllStops()}catch(e){console.error(e)}}

function mkIcon(color,size){
    return L.divIcon({html:`<div style="width:${size}px;height:${size}px;background:${color};border:2px solid rgba(255,255,255,.9);border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,.4)"></div>`,className:'',iconSize:[size,size],iconAnchor:[size/2,size/2]});
}

function showAllStops(){
    stopMarkers.forEach(m=>map.removeLayer(m));stopMarkers=[];
    const bounds=[];
    stops.forEach(s=>{
        const ll=[s.latitude,s.longitude];bounds.push(ll);
        const m=L.marker(ll,{icon:mkIcon('#3b82f6',8)}).addTo(map);
        m.bindPopup(`<b>${s.name}</b><br><small>${s.id}</small>`);
        stopMarkers.push(m);
    });
    if(bounds.length)map.fitBounds(bounds,{padding:[40,40]});
}

// ==================== AUTOCOMPLETE ====================
function setupAC(inId,listId,type){
    const inp=document.getElementById(inId),list=document.getElementById(listId);
    inp.addEventListener('input',()=>{
        const q=inp.value.trim().toLowerCase();
        if(q.length<1){list.classList.remove('show');return}
        const m=stops.filter(s=>s.name.toLowerCase().includes(q)||s.id.toLowerCase().includes(q)).slice(0,6);
        if(!m.length){list.classList.remove('show');return}
        list.innerHTML=m.map(s=>`<div class="acitem" data-id="${s.id}"><div class="badge">${s.id}</div><div><div class="sname">${s.name}</div><div class="scoord">${s.latitude.toFixed(4)}, ${s.longitude.toFixed(4)}</div></div></div>`).join('');
        list.classList.add('show');
        list.querySelectorAll('.acitem').forEach(it=>it.onclick=()=>{
            const st=stops.find(s=>s.id===it.dataset.id);
            inp.value=st.name;list.classList.remove('show');
            if(type==='src')selSrc=st;else selDst=st;
        });
    });
    document.addEventListener('click',e=>{if(!e.target.closest('.search-row'))list.classList.remove('show')});
}

function useMyLocation(){
    if(!navigator.geolocation){alert('Geolocation not supported');return}
    navigator.geolocation.getCurrentPosition(p=>{
        let near=null,md=Infinity;
        stops.forEach(s=>{const d=Math.hypot(s.latitude-p.coords.latitude,s.longitude-p.coords.longitude);if(d<md){md=d;near=s}});
        if(near){document.getElementById('srcIn').value=near.name;selSrc=near}
    },()=>alert('Enable GPS'));
}
function swap(){
    const a=document.getElementById('srcIn'),b=document.getElementById('dstIn');
    const tv=a.value;a.value=b.value;b.value=tv;
    const ts=selSrc;selSrc=selDst;selDst=ts;
}

// ==================== OSRM ROAD ROUTING ====================
// Gets real road geometry between two lat/lng points using free OSRM API
async function getRoadRoute(lat1, lng1, lat2, lng2) {
    const key = `${lat1},${lng1}-${lat2},${lng2}`;
    if (roadCache[key]) return roadCache[key];

    try {
        const url = `${OSRM}/${lng1},${lat1};${lng2},${lat2}?overview=full&geometries=geojson`;
        const resp = await fetch(url);
        const data = await resp.json();

        if (data.routes && data.routes.length > 0) {
            // OSRM returns [lng,lat] ‚Äî convert to [lat,lng] for Leaflet
            const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            roadCache[key] = coords;
            return coords;
        }
    } catch(e) {
        console.warn('OSRM failed, using straight line', e);
    }

    // Fallback: straight line
    return [[lat1, lng1], [lat2, lng2]];
}

// Get road route for a bus segment that may pass through multiple stops
async function getFullBusRoute(segment) {
    // If backend provided polyline with intermediate points, route through each pair
    if (segment.polyline && segment.polyline.length > 1) {
        const allCoords = [];
        for (let i = 0; i < segment.polyline.length - 1; i++) {
            const p1 = segment.polyline[i];
            const p2 = segment.polyline[i + 1];
            const roadCoords = await getRoadRoute(p1[0], p1[1], p2[0], p2[1]);
            if (allCoords.length === 0) {
                allCoords.push(...roadCoords);
            } else {
                // skip first to avoid duplicate junction points
                allCoords.push(...roadCoords.slice(1));
            }
        }
        return allCoords;
    }

    // Otherwise route directly from start to end
    return await getRoadRoute(segment.fromLat, segment.fromLng, segment.toLat, segment.toLng);
}

// ==================== FIND TRANSIT ====================
async function findTransit(){
    if(!selSrc||!selDst){alert('Select both locations');return}
    if(selSrc.id===selDst.id){alert('Same location');return}
    document.getElementById('results').innerHTML='<div class="loading"><div class="spinner"></div><p>Finding bus routes...</p></div>';

    try{
        const r=await fetch(`${API}/transit?source=${selSrc.id}&destination=${selDst.id}`);
        const options=await r.json();
        if(options.length>0){
            renderOptions(options);
        } else {
            document.getElementById('results').innerHTML='<div class="empty"><div class="eicon">‚ùå</div><h3>No routes found</h3></div>';
        }
    }catch(e){
        document.getElementById('results').innerHTML='<div class="empty"><div class="eicon">‚ö†Ô∏è</div><h3>API Error</h3><p>Is the backend running?</p></div>';
    }
}

function renderOptions(options){
    const c=document.getElementById('results');
    c.innerHTML=options.map((opt,idx)=>{
        const segStrip=opt.segments.map((seg,si)=>{
            if(seg.type==='walk')return `<span class="seg-walk"><span class="wicon">üö∂</span>${seg.durationMinutes}m</span>${si<opt.segments.length-1?'<span class="seg-arrow">‚Ä∫</span>':''}`;
            const ci=si%COLORS.length;
            return `<span class="seg-bus"><span class="bicon">üöå</span><span class="bus-badge ${COLOR_NAMES[ci]}">${seg.busNumber}</span></span>${si<opt.segments.length-1?'<span class="seg-arrow">‚Ä∫</span>':''}`;
        }).join('');

        const detail=opt.segments.map((seg,si)=>{
            if(seg.type==='walk')return `<div class="detail-seg"><div class="d-line walk"></div><div class="d-content"><div class="d-type walk">üö∂ Walk ${seg.durationMinutes} min</div><div class="d-text">${seg.fromStop} ‚Üí ${seg.toStop}</div></div></div>`;
            const ci=si%COLORS.length;
            return `<div class="detail-seg"><div class="d-line bus" style="background:${COLORS[ci]}"></div><div class="d-content"><div class="d-type bus">üöå Bus ${seg.busNumber} ¬∑ ${seg.stopCount} stops ¬∑ ${seg.durationMinutes} min</div><div class="d-text">${seg.fromStop} ‚Üí ${seg.toStop}</div><div class="d-sub">${seg.distanceKm} km ¬∑ Rs. ${seg.costRs}</div></div></div>`;
        }).join('');

        return `
        <div class="tcard${idx===0?' active':''}" onclick="selectOption(${idx})" data-idx="${idx}">
            ${idx===0?`<div class="tcard-label">${opt.label}</div>`:''}
            <div class="tcard-top">
                <span class="tcard-time">${opt.departureTime} ‚Äî ${opt.arrivalTime}</span>
                <span class="tcard-dur">${formatDur(opt.totalDurationMinutes)}</span>
            </div>
            <div class="seg-strip">${segStrip}</div>
            <div class="tcard-info">
                <span>üí∞ Rs. ${opt.totalCostRs}</span>
                <span>üìç ${opt.totalStops} stops</span>
                <span>üîÑ ${opt.transfers} transfer${opt.transfers!==1?'s':''}</span>
            </div>
            <div class="tcard-detail">${detail}</div>
        </div>`;
    }).join('');

    activeCard=0;
    window._transitOptions=options;
    drawTransitOnMap(options[0]);
}

function selectOption(idx){
    document.querySelectorAll('.tcard').forEach((c,i)=>c.classList.toggle('active',i===idx));
    activeCard=idx;
    drawTransitOnMap(window._transitOptions[idx]);
}

function formatDur(m){
    if(m<60)return m+' min';
    const h=Math.floor(m/60),rm=m%60;
    return h+'h '+rm+'m';
}

// ==================== DRAW ROUTE ON MAP (Real Roads via OSRM) ====================
async function drawTransitOnMap(opt){
    routeLayers.forEach(l=>map.removeLayer(l));routeLayers=[];
    const bounds=[];

    // Show loading
    document.getElementById('mapLoading').classList.add('show');

    for(let si=0; si<opt.segments.length; si++){
        const seg=opt.segments[si];
        const from=[seg.fromLat,seg.fromLng], to=[seg.toLat,seg.toLng];
        bounds.push(from,to);

        if(seg.type==='walk'){
            // Walking: dashed line (straight is OK for walking)
            const line=L.polyline([from,to],{
                color:'#94a3b8',weight:4,dashArray:'8,10',opacity:.7
            }).addTo(map);
            routeLayers.push(line);

        } else {
            // BUS: Get real road geometry from OSRM
            const ci=si%COLORS.length;
            const roadCoords = await getFullBusRoute(seg);

            // Add all road points to bounds
            roadCoords.forEach(p=>bounds.push(p));

            // Draw thick road-following polyline (like Google Maps)
            // Shadow line (wider, darker)
            const shadow=L.polyline(roadCoords,{
                color:'rgba(0,0,0,0.3)',weight:10,opacity:1,lineCap:'round',lineJoin:'round'
            }).addTo(map);
            routeLayers.push(shadow);

            // Main colored line
            const line=L.polyline(roadCoords,{
                color:COLORS[ci],weight:7,opacity:0.9,lineCap:'round',lineJoin:'round'
            }).addTo(map);
            routeLayers.push(line);

            // Bus number label at midpoint
            const midIdx=Math.floor(roadCoords.length/2);
            const mid=roadCoords[midIdx];
            const lbl=L.divIcon({
                html:`<div style="background:${COLORS[ci]};color:white;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;font-family:'Space Mono',monospace;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.5)">üöå ${seg.busNumber}</div>`,
                className:'',iconAnchor:[20,-5]
            });
            const lm=L.marker(mid,{icon:lbl,interactive:false}).addTo(map);
            routeLayers.push(lm);

            // Board stop marker
            const sm=L.marker(from,{icon:mkIcon(COLORS[ci],14)}).addTo(map);
            sm.bindPopup(`<div style="font-family:'DM Sans';"><b>üöå Board here</b><br>${seg.fromStop}<br><span style="color:#3b82f6;font-weight:700">Bus ${seg.busNumber}</span></div>`);
            routeLayers.push(sm);

            // Alight stop marker
            const em=L.marker(to,{icon:mkIcon(COLORS[ci],14)}).addTo(map);
            em.bindPopup(`<div style="font-family:'DM Sans';"><b>üîΩ Get off here</b><br>${seg.toStop}<br><span style="color:#3b82f6;font-weight:700">Bus ${seg.busNumber}</span></div>`);
            routeLayers.push(em);
        }
    }

    // Start & End big markers
    if(opt.segments.length>0){
        const first=opt.segments[0];
        const last=opt.segments[opt.segments.length-1];

        const startM=L.marker([first.fromLat,first.fromLng],{icon:mkIcon('#22c55e',20)}).addTo(map);
        startM.bindPopup('<b>üìç Start</b>');routeLayers.push(startM);

        const endM=L.marker([last.toLat,last.toLng],{icon:mkIcon('#ef4444',20)}).addTo(map);
        endM.bindPopup('<b>üéØ Destination</b>');routeLayers.push(endM);
    }

    // Hide loading
    document.getElementById('mapLoading').classList.remove('show');

    if(bounds.length)map.fitBounds(bounds,{padding:[60,60]});
}
</script>
</body>
</html>